# SoundFlow - GCP Pipeline Architecture

## ğŸ—ï¸ Tá»•ng Quan Kiáº¿n TrÃºc

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           SOUNDFLOW GCP ARCHITECTURE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚             â”‚     â”‚                    GOOGLE CLOUD PLATFORM                 â”‚ â”‚
â”‚  â”‚  EventSim   â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚  â”‚  (Producer) â”‚â”€â”€â”€â”€â–¶â”‚  â”‚              CLOUD PUB/SUB                          â”‚â”‚ â”‚
â”‚  â”‚             â”‚     â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚  â”‚listen_eventsâ”‚ â”‚page_views â”‚ â”‚auth_eventsâ”‚       â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â”‚â”‚ â”‚
â”‚                      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚                      â”‚            â”‚             â”‚              â”‚               â”‚ â”‚
â”‚                      â”‚            â–¼             â–¼              â–¼               â”‚ â”‚
â”‚                      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚                      â”‚  â”‚                  DATAPROC CLUSTER                   â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â”‚              SPARK STREAMING                    â”‚â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â”‚  â€¢ Read from Pub/Sub subscriptions              â”‚â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â”‚  â€¢ Parse JSON events                            â”‚â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â”‚  â€¢ Add timestamps & partitions                  â”‚â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â”‚  â€¢ Write Parquet to GCS                         â”‚â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚ â”‚
â”‚                      â”‚  â”‚        Master (1x n1-standard-4)                    â”‚â”‚ â”‚
â”‚                      â”‚  â”‚        Workers (2x n1-standard-4)                   â”‚â”‚ â”‚
â”‚                      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚                      â”‚                          â”‚                              â”‚ â”‚
â”‚                      â”‚                          â–¼                              â”‚ â”‚
â”‚                      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚                      â”‚  â”‚           GOOGLE CLOUD STORAGE (Data Lake)          â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  gs://soundflow-data-lake/                          â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â”œâ”€â”€ raw/                                           â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â”‚   â”œâ”€â”€ listen_events/year=*/month=*/day=*/hour=*/ â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â”‚   â”œâ”€â”€ page_view_events/...                       â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â”‚   â”œâ”€â”€ auth_events/...                            â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â”‚   â””â”€â”€ status_change_events/...                   â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â”œâ”€â”€ checkpoints/spark/                             â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â””â”€â”€ spark-apps/                                    â”‚â”‚ â”‚
â”‚                      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚                      â”‚                          â”‚                              â”‚ â”‚
â”‚                      â”‚                          â–¼                              â”‚ â”‚
â”‚                      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚                      â”‚  â”‚              BIGQUERY (Data Warehouse)              â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â”‚   RAW    â”‚  â”‚ STAGING  â”‚  â”‚INTERMEDI-â”‚          â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â”‚ External â”‚â”€â–¶â”‚  Views   â”‚â”€â–¶â”‚   ATE    â”‚          â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â”‚  Tables  â”‚  â”‚(dbt stg_)â”‚  â”‚(dbt int_)â”‚          â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â”‚â”‚ â”‚
â”‚                      â”‚  â”‚                                    â”‚                â”‚â”‚ â”‚
â”‚                      â”‚  â”‚                                    â–¼                â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â”‚                    MARTS                       â”‚ â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚ â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â”‚  â”‚top_songs â”‚ â”‚top_users â”‚ â”‚  hourly  â”‚       â”‚ â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â”‚  â”‚          â”‚ â”‚          â”‚ â”‚ metrics  â”‚       â”‚ â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ â”‚â”‚ â”‚
â”‚                      â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚ â”‚
â”‚                      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚                      â”‚                          â”‚                              â”‚ â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                 â”‚                                â”‚
â”‚                                                 â–¼                                â”‚
â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                                    â”‚      POWER BI /        â”‚                    â”‚
â”‚                                    â”‚   LOOKER STUDIO        â”‚                    â”‚
â”‚                                    â”‚    (Dashboards)        â”‚                    â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Chi Tiáº¿t Tá»«ng Component

### 1ï¸âƒ£ **Event Generator (EventSim)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              EVENTSIM                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Giáº£ láº­p hÃ nh vi ngÆ°á»i dÃ¹ng nghe nháº¡c      â”‚
â”‚ â€¢ Táº¡o 4 loáº¡i events:                        â”‚
â”‚   - listen_events (nghe nháº¡c)               â”‚
â”‚   - page_view_events (xem trang)            â”‚
â”‚   - auth_events (Ä‘Äƒng nháº­p)                 â”‚
â”‚   - status_change_events (nÃ¢ng cáº¥p gÃ³i)     â”‚
â”‚ â€¢ Output: JSON messages â†’ Pub/Sub           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Publish to Pub/Sub:**
```python
from google.cloud import pubsub_v1

publisher = pubsub_v1.PublisherClient()
topic_path = publisher.topic_path('project-id', 'listen-events')

data = json.dumps(event).encode('utf-8')
publisher.publish(topic_path, data)
```

---

### 2ï¸âƒ£ **Cloud Pub/Sub (Message Queue)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            CLOUD PUB/SUB                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Topics:                                      â”‚
â”‚ â”œâ”€â”€ listen-events                           â”‚
â”‚ â”œâ”€â”€ page-view-events                        â”‚
â”‚ â”œâ”€â”€ auth-events                             â”‚
â”‚ â””â”€â”€ status-change-events                    â”‚
â”‚                                              â”‚
â”‚ Subscriptions (for Spark):                   â”‚
â”‚ â”œâ”€â”€ listen-events-spark-sub                 â”‚
â”‚ â”œâ”€â”€ page-view-events-spark-sub              â”‚
â”‚ â”œâ”€â”€ auth-events-spark-sub                   â”‚
â”‚ â””â”€â”€ status-change-events-spark-sub          â”‚
â”‚                                              â”‚
â”‚ Features:                                    â”‚
â”‚ â€¢ Message retention: 7 days                 â”‚
â”‚ â€¢ Dead letter queue for failed messages     â”‚
â”‚ â€¢ At-least-once delivery guarantee          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Táº¡i sao dÃ¹ng Pub/Sub thay Kafka?**
| Feature | Kafka (Local) | Pub/Sub (GCP) |
|---------|---------------|---------------|
| Managed | âŒ Self-hosted | âœ… Fully managed |
| Scaling | Manual | Auto-scaling |
| Cost | Server cost | Pay-per-message |
| Latency | Very low | Low |
| Integration | Manual | Native GCP |

---

### 3ï¸âƒ£ **Dataproc Cluster (Spark Streaming)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATAPROC CLUSTER                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    MASTER NODE                         â”‚  â”‚
â”‚  â”‚  â€¢ Machine: n1-standard-4 (4 vCPU, 15GB RAM)          â”‚  â”‚
â”‚  â”‚  â€¢ YARN ResourceManager                                â”‚  â”‚
â”‚  â”‚  â€¢ Spark Driver                                        â”‚  â”‚
â”‚  â”‚  â€¢ Web UIs: Spark UI, YARN UI, Jupyter                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                  â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚           â–¼               â–¼               â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  WORKER 1   â”‚ â”‚  WORKER 2   â”‚ â”‚ PREEMPTIBLE â”‚           â”‚
â”‚  â”‚ n1-std-4    â”‚ â”‚ n1-std-4    â”‚ â”‚ (Optional)  â”‚           â”‚
â”‚  â”‚ Executor    â”‚ â”‚ Executor    â”‚ â”‚ Cost saving â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                              â”‚
â”‚  Software:                                                   â”‚
â”‚  â€¢ Spark 3.3.x                                              â”‚
â”‚  â€¢ Hadoop 3.3.x                                             â”‚
â”‚  â€¢ Python 3.10                                              â”‚
â”‚  â€¢ Pub/Sub Spark Connector                                  â”‚
â”‚  â€¢ GCS Connector                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Spark Streaming Job Flow:**
```
Pub/Sub â”€â”€â–¶ Read Stream â”€â”€â–¶ Parse JSON â”€â”€â–¶ Transform â”€â”€â–¶ Write Parquet to GCS
                â”‚               â”‚             â”‚               â”‚
                â”‚               â”‚             â”‚               â”‚
            Subscribe       Schema        Add columns      Partitioned by
            to topics       validation    (timestamp,       year/month/
                                          year, month,      day/hour
                                          day, hour)
```

---

### 4ï¸âƒ£ **Google Cloud Storage (Data Lake)**

```
gs://soundflow-data-lake/
â”‚
â”œâ”€â”€ ğŸ“ raw/                          # Raw events (Parquet)
â”‚   â”œâ”€â”€ listen_events/
â”‚   â”‚   â”œâ”€â”€ year=2024/
â”‚   â”‚   â”‚   â”œâ”€â”€ month=01/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ day=15/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ hour=00/
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ part-00000.parquet
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ part-00001.parquet
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ hour=01/
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ page_view_events/
â”‚   â”œâ”€â”€ auth_events/
â”‚   â””â”€â”€ status_change_events/
â”‚
â”œâ”€â”€ ğŸ“ checkpoints/                  # Spark checkpoints
â”‚   â””â”€â”€ spark/
â”‚       â”œâ”€â”€ listen/
â”‚       â”œâ”€â”€ page_view/
â”‚       â””â”€â”€ auth/
â”‚
â”œâ”€â”€ ğŸ“ spark-apps/                   # Spark applications
â”‚   â””â”€â”€ streaming_to_gcs_pubsub.py
â”‚
â””â”€â”€ ğŸ“ scripts/                      # Init scripts
    â””â”€â”€ dataproc-init.sh
```

**Táº¡i sao dÃ¹ng Parquet?**
- âœ… Columnar format â†’ Fast analytics
- âœ… Compression (Snappy) â†’ 70% smaller
- âœ… Schema evolution support
- âœ… Predicate pushdown
- âœ… Native BigQuery support

---

### 5ï¸âƒ£ **BigQuery (Data Warehouse)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       BIGQUERY                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ RAW Dataset (External Tables)                           â”‚â”‚
â”‚  â”‚ â€¢ listen_events      â†’ Points to GCS Parquet            â”‚â”‚
â”‚  â”‚ â€¢ page_view_events   â†’ Auto-detect partition            â”‚â”‚
â”‚  â”‚ â€¢ auth_events        â†’ Hive-style partitioning          â”‚â”‚
â”‚  â”‚ â€¢ status_change_events                                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                           â”‚ dbt run                         â”‚
â”‚                           â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ STAGING Dataset (Views)                                 â”‚â”‚
â”‚  â”‚ â€¢ stg_listens        â†’ Clean, standardize               â”‚â”‚
â”‚  â”‚ â€¢ stg_page_views     â†’ Add derived columns              â”‚â”‚
â”‚  â”‚ â€¢ stg_auth           â†’ Filter invalid records           â”‚â”‚
â”‚  â”‚ â€¢ stg_status_changes                                    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                           â”‚                                 â”‚
â”‚                           â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ INTERMEDIATE Dataset (Views)                            â”‚â”‚
â”‚  â”‚ â€¢ int_user_activity  â†’ User-level aggregation           â”‚â”‚
â”‚  â”‚ â€¢ int_song_stats     â†’ Song-level metrics               â”‚â”‚
â”‚  â”‚ â€¢ int_daily_metrics  â†’ Daily KPIs                       â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                           â”‚                                 â”‚
â”‚                           â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ MARTS Dataset (Tables - Materialized)                   â”‚â”‚
â”‚  â”‚ â€¢ mart_top_songs     â†’ Top 100 songs                    â”‚â”‚
â”‚  â”‚ â€¢ mart_top_artists   â†’ Top 100 artists                  â”‚â”‚
â”‚  â”‚ â€¢ mart_active_users  â†’ User engagement                  â”‚â”‚
â”‚  â”‚ â€¢ mart_hourly_metricsâ†’ Time-series (incremental)        â”‚â”‚
â”‚  â”‚ â€¢ mart_daily_summary â†’ Executive dashboard              â”‚â”‚
â”‚  â”‚ â€¢ mart_location_analytics â†’ Geographic insights         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Data Flow Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EventSim â”‚â”€â”€â”€â–¶â”‚ Pub/Sub  â”‚â”€â”€â”€â–¶â”‚ Dataproc â”‚â”€â”€â”€â–¶â”‚   GCS    â”‚â”€â”€â”€â–¶â”‚ BigQuery â”‚
â”‚          â”‚    â”‚ (Queue)  â”‚    â”‚ (Spark)  â”‚    â”‚ (Lake)   â”‚    â”‚  (DW)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
  Generate      Buffer &         Process &       Store raw       Analytics
  events        Decouple         Transform       Parquet          & BI
                                                                    â”‚
                                                                    â–¼
                                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                            â”‚ Power BI /   â”‚
                                                            â”‚ Looker Studioâ”‚
                                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Latency Timeline:
```
EventSim â”€â”€[<1s]â”€â”€â–¶ Pub/Sub â”€â”€[~2min]â”€â”€â–¶ GCS â”€â”€[dbt run]â”€â”€â–¶ BigQuery â”€â”€â–¶ Dashboard
                              â”‚
                        Micro-batch
                        (2 min trigger)
```

---

## ğŸ’° Cost Estimation

| Component | Configuration | Est. Monthly Cost |
|-----------|--------------|-------------------|
| **Dataproc** | 1 master + 2 workers (n1-standard-4), 8hr/day | ~$150 |
| **GCS** | 100GB storage + operations | ~$5 |
| **BigQuery** | 1TB queries + 10GB storage | ~$10 |
| **Pub/Sub** | 1M messages/day | ~$1 |
| **Total** | | **~$166/month** |

### Cost Optimization Tips:
1. **Use Preemptible Workers**: 60-80% cheaper
2. **Auto-stop Dataproc**: Turn off when not streaming
3. **BigQuery Partitioning**: Reduce scanned data
4. **GCS Lifecycle**: Archive old data to Coldline

---

## ğŸš€ Deployment Commands

### 1. Deploy Infrastructure:
```bash
cd terraform
terraform init
terraform plan
terraform apply -var="enable_dataproc=true"
```

### 2. Submit Spark Job:
```bash
gcloud dataproc jobs submit pyspark \
    gs://soundflow-data-lake/spark-apps/streaming_to_gcs_pubsub.py \
    --project=your-project-id \
    --region=asia-southeast1 \
    --cluster=soundflow-spark-dev \
    --properties="spark.jars.packages=com.google.cloud.spark:spark-pubsub_2.12:0.21.0"
```

### 3. Run dbt Models:
```bash
cd dbt
export DBT_TARGET=prod
dbt run --target prod
```

### 4. Monitor Pipeline:
- **Dataproc UI**: https://console.cloud.google.com/dataproc
- **Spark UI**: Available via Dataproc cluster
- **BigQuery**: https://console.cloud.google.com/bigquery
- **GCS**: https://console.cloud.google.com/storage

---

## ğŸ”’ Security

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SERVICE ACCOUNTS                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  soundflow-spark@project.iam                                â”‚
â”‚  â”œâ”€â”€ roles/pubsub.subscriber     (Read Pub/Sub)             â”‚
â”‚  â”œâ”€â”€ roles/storage.objectAdmin   (Write GCS)                â”‚
â”‚  â””â”€â”€ roles/bigquery.dataEditor   (Write BQ - optional)      â”‚
â”‚                                                              â”‚
â”‚  soundflow-dbt@project.iam                                  â”‚
â”‚  â”œâ”€â”€ roles/bigquery.dataEditor   (Create tables)            â”‚
â”‚  â”œâ”€â”€ roles/bigquery.jobUser      (Run queries)              â”‚
â”‚  â””â”€â”€ roles/storage.objectViewer  (Read GCS for external)    â”‚
â”‚                                                              â”‚
â”‚  soundflow-dagster@project.iam                              â”‚
â”‚  â”œâ”€â”€ roles/bigquery.dataViewer   (Monitor)                  â”‚
â”‚  â”œâ”€â”€ roles/run.invoker           (Trigger Cloud Run)        â”‚
â”‚  â””â”€â”€ roles/pubsub.publisher      (Trigger events)           â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ Scaling Guide

| Scale | EventSim | Dataproc | BigQuery |
|-------|----------|----------|----------|
| **Small** (10K events/day) | 1 instance | 1M + 2W | On-demand |
| **Medium** (1M events/day) | 3 instances | 1M + 4W | On-demand |
| **Large** (100M events/day) | Kubernetes | 1M + 10W + autoscale | Flat-rate |

---

## âœ… So SÃ¡nh Local vs GCP

| Aspect | Local Stack | GCP Stack |
|--------|-------------|-----------|
| **Message Queue** | Redpanda/Kafka | Cloud Pub/Sub |
| **Stream Processing** | Spark (Docker) | Dataproc (Managed) |
| **Data Lake** | PostgreSQL | GCS + BigQuery External |
| **Data Warehouse** | PostgreSQL | BigQuery |
| **Orchestration** | Dagster (Docker) | Dagster (Cloud Run) |
| **Cost** | Server hardware | Pay-as-you-go |
| **Scaling** | Manual | Auto-scaling |
| **Maintenance** | High | Low (Managed) |
